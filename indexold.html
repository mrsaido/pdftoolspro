<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pdf tools pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>
    <style>
        .dropzone {
            border: 2px dashed #3b82f6;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .dropzone.active {
            border-color: #10b981;
            background-color: #f0f9ff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .signature-preview {
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- En-tête -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold text-blue-800">Pouvoir Judiciaire de Neuquén</div>
            <div class="text-xl font-bold text-gray-700">AIGDE</div>
        </div>
    </header>

    <!-- Contenu principal -->
    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <!-- Onglets -->
            <div class="flex border-b">
                <button class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-blue-600 focus:outline-none border-b-2 border-transparent hover:border-blue-300 transition" data-tab="merge">
                    <i class="fas fa-object-group mr-2"></i> Fusionner des PDF
                </button>
                <button class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-blue-600 focus:outline-none border-b-2 border-transparent hover:border-blue-300 transition" data-tab="extract">
                    <i class="fas fa-cut mr-2"></i> Extraire des pages
                </button>
                <button class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-blue-600 focus:outline-none border-b-2 border-transparent hover:border-blue-300 transition" data-tab="compress">
                    <i class="fas fa-compress-alt mr-2"></i> Compresser
                </button>
                <button class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-blue-600 focus:outline-none border-b-2 border-transparent hover:border-blue-300 transition" data-tab="sign">
                    <i class="fas fa-signature mr-2"></i> Signer
                </button>
            </div>

            <!-- Contenu des onglets -->
            <div class="p-6">
                <!-- Fusionner des PDF -->
                <div id="merge" class="tab-content active">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Fusionner plusieurs fichiers PDF en un seul</h2>
                    <div class="dropzone p-8 mb-4 text-center cursor-pointer" id="merge-dropzone">
                        <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-2"></i>
                        <p class="text-gray-600">Glissez-déposez vos fichiers PDF ici ou cliquez pour sélectionner</p>
                        <input type="file" id="merge-files" class="hidden" accept=".pdf" multiple>
                    </div>
                    <div id="merge-file-list" class="mb-4 space-y-2"></div>
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="merge-number-pages" class="mr-2">
                                <span class="text-gray-700">Numéroter les pages</span>
                            </label>
                        </div>
                        <button id="merge-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-object-group mr-2"></i> Fusionner les PDF
                        </button>
                    </div>
                    <div id="merge-progress" class="hidden">
                        <div class="mb-2 text-sm text-gray-600">Traitement en cours...</div>
                        <div class="progress-bar">
                            <div id="merge-progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>


               <!-- Extraire des pages -->
<div id="extract" class="tab-content">
    <h2 class="text-xl font-semibold mb-4 text-gray-800">Extraire des pages d’un fichier PDF</h2>
    <div class="dropzone p-8 mb-4 text-center cursor-pointer" id="extract-dropzone">
        <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-2"></i>
        <p class="text-gray-600">Glissez-déposez un fichier PDF ici ou cliquez pour sélectionner</p>
        <input type="file" id="extract-file" class="hidden" accept=".pdf">
    </div>
    <div id="extract-file-info" class="hidden mb-4 p-3 bg-gray-50 rounded-md">
        <div class="flex justify-between items-center">
            <span class="font-medium text-gray-700" id="extract-file-name"></span>
            <span class="text-sm text-gray-500" id="extract-page-count"></span>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Plage de pages</label>
            <input type="text" id="extract-range" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex : 1-3, 5, 7-9">
            <p class="text-xs text-gray-500 mt-1">Séparez les plages (1-3) ou pages individuelles (5) avec des virgules</p>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ou sélectionnez les pages</label>
            <div id="extract-page-selector" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 border border-gray-300 rounded-md"></div>
        </div>
    </div>
    <div class="flex justify-end">
        <button id="extract-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i class="fas fa-cut mr-2"></i> Extraire les pages
        </button>
    </div>
    <div id="extract-progress" class="hidden mt-4">
        <div class="mb-2 text-sm text-gray-600">Traitement en cours...</div>
        <div class="progress-bar">
            <div id="extract-progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- Compresser un PDF -->
<div id="compress" class="tab-content">
    <h2 class="text-xl font-semibold mb-4 text-gray-800">Compresser un fichier PDF</h2>
    <div class="dropzone p-8 mb-4 text-center cursor-pointer" id="compress-dropzone">
        <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-2"></i>
        <p class="text-gray-600">Glissez-déposez un fichier PDF ici ou cliquez pour sélectionner</p>
        <input type="file" id="compress-file" class="hidden" accept=".pdf">
    </div>
    <div id="compress-file-info" class="hidden mb-4 p-3 bg-gray-50 rounded-md">
        <div class="flex justify-between items-center">
            <span class="font-medium text-gray-700" id="compress-file-name"></span>
            <span class="text-sm text-gray-500" id="compress-file-size"></span>
        </div>
    </div>
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Niveau de compression</label>
        <div class="flex items-center space-x-4">
            <input type="range" id="compress-level" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            <span id="compress-level-value" class="text-sm font-medium text-gray-700 w-8">5</span>
        </div>
        <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>Basse qualité</span>
            <span>Haute qualité</span>
        </div>
    </div>
    <div class="flex justify-between items-center mb-4">
        <div>
            <label class="flex items-center">
                <input type="checkbox" id="compress-optimize-images" class="mr-2" checked>
                <span class="text-gray-700">Optimiser les images</span>
            </label>
        </div>
        <button id="compress-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i class="fas fa-compress-alt mr-2"></i> Compresser
        </button>
    </div>
    <div id="compress-progress" class="hidden">
        <div class="mb-2 text-sm text-gray-600">Compression en cours...</div>
        <div class="progress-bar">
            <div id="compress-progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
    </div>
    <div id="compress-result" class="hidden mt-4 p-3 bg-green-50 rounded-md border border-green-200">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="font-medium text-green-800">Compression terminée</h3>
                <p class="text-sm text-green-600">Taille originale : <span id="original-size" class="font-medium"></span></p>
            </div>
            <div class="text-right">
                <p class="text-sm text-green-600">Taille compressée : <span id="compressed-size" class="font-medium"></span></p>
                <p class="text-sm text-green-600">Réduction : <span id="reduction-percent" class="font-medium"></span></p>
            </div>
        </div>
    </div>
</div>

<!-- Signer un PDF -->
<div id="sign" class="tab-content">
    <h2 class="text-xl font-semibold mb-4 text-gray-800">Signer un document PDF</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <div class="dropzone p-8 mb-4 text-center cursor-pointer" id="sign-dropzone">
                <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-2"></i>
                <p class="text-gray-600">Glissez-déposez un fichier PDF ici ou cliquez pour sélectionner</p>
                <input type="file" id="sign-file" class="hidden" accept=".pdf">
            </div>
            <div id="sign-file-info" class="hidden mb-4 p-3 bg-gray-50 rounded-md">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-700" id="sign-file-name"></span>
                    <span class="text-sm text-gray-500" id="sign-page-count"></span>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Page à signer</label>
                <select id="sign-page" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    <option value="last">Dernière page</option>
                    <option value="first">Première page</option>
                    <option value="all">Toutes les pages</option>
                    <option value="custom">Page spécifique</option>
                </select>
            </div>
            <div id="sign-custom-page-container" class="hidden mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Numéro de page</label>
                <input type="number" id="sign-custom-page" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>
        <div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Signature numérique</label>
                <div class="flex space-x-2 mb-2">
                    <button id="sign-upload-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm transition">
                        <i class="fas fa-upload mr-2"></i> Télécharger une image
                    </button>
                    <button id="sign-draw-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm transition">
                        <i class="fas fa-pen mr-2"></i> Dessiner une signature
                    </button>
                    <button id="sign-token-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm transition">
                        <i class="fas fa-key mr-2"></i> Utiliser un e-Token
                    </button>
                </div>
                <div class="signature-preview rounded-md mb-2" id="signature-preview">
                    <p class="text-gray-400">Aperçu de la signature</p>
                </div>
                <input type="file" id="sign-image" class="hidden" accept="image/*">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Position de la signature</label>
                <select id="sign-position" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="bottom-right">En bas à droite</option>
                    <option value="bottom-left">En bas à gauche</option>
                    <option value="top-right">En haut à droite</option>
                    <option value="top-left">En haut à gauche</option>
                    <option value="center">Centre</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Taille de la signature</label>
                <input type="range" id="sign-size" min="50" max="200" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Petite</span>
                    <span>Grande</span>
                </div>
            </div>
            <div class="flex justify-end">
                <button id="sign-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-signature mr-2"></i> Signer le document
                </button>
            </div>
        </div>
    </div>
    <div id="sign-progress" class="hidden mt-4">
        <div class="mb-2 text-sm text-gray-600">Signature en cours...</div>
        <div class="progress-bar">
            <div id="sign-progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
    </div>
</div>


    <script>
        // Manejo de pestañas
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                
                // Desactivar todas las pestañas
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-blue-600', 'text-blue-600');
                    b.classList.add('border-transparent', 'text-gray-600');
                });
                
                // Activar la pestaña seleccionada
                btn.classList.remove('border-transparent', 'text-gray-600');
                btn.classList.add('border-blue-600', 'text-blue-600');
                
                // Ocultar todos los contenidos
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Mostrar el contenido seleccionado
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Funcionalidad para Unir PDFs
        const mergeDropzone = document.getElementById('merge-dropzone');
        const mergeFilesInput = document.getElementById('merge-files');
        const mergeFileList = document.getElementById('merge-file-list');
        const mergeBtn = document.getElementById('merge-btn');
        const mergeProgress = document.getElementById('merge-progress');
        const mergeProgressFill = document.getElementById('merge-progress-fill');

        let mergeFiles = [];

        mergeDropzone.addEventListener('click', () => mergeFilesInput.click());
        mergeDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            mergeDropzone.classList.add('active');
        });
        mergeDropzone.addEventListener('dragleave', () => {
            mergeDropzone.classList.remove('active');
        });
        mergeDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            mergeDropzone.classList.remove('active');
            handleMergeFiles(e.dataTransfer.files);
        });

        mergeFilesInput.addEventListener('change', () => {
            handleMergeFiles(mergeFilesInput.files);
        });

        function handleMergeFiles(files) {
            mergeFiles = [];
            mergeFileList.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type === 'application/pdf') {
                    mergeFiles.push(file);
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md';
                    fileItem.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                            <span class="text-sm">${file.name}</span>
                        </div>
                        <span class="text-xs text-gray-500">${formatFileSize(file.size)}</span>
                    `;
                    mergeFileList.appendChild(fileItem);
                }
            }
            
            mergeBtn.disabled = mergeFiles.length < 2;
        }

        mergeBtn.addEventListener('click', async () => {
            if (mergeFiles.length < 2) return;
            
            mergeProgress.classList.remove('hidden');
            mergeProgressFill.style.width = '0%';
            
            try {
                // Crear un nuevo PDF
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                
                let progress = 0;
                const progressIncrement = 100 / mergeFiles.length;
                
                // Procesar cada archivo PDF
                for (const file of mergeFiles) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    
                    // Copiar páginas al PDF final
                    const pages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                    pages.forEach(page => mergedPdf.addPage(page));
                    
                    // Actualizar progreso
                    progress += progressIncrement;
                    mergeProgressFill.style.width = `${Math.min(progress, 100)}%`;
                }
                
                // Guardar el PDF unido
                const mergedPdfBytes = await mergedPdf.save();
                const mergedPdfBlob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                
                // Descargar el PDF
                const mergedName = `documento_unido_${new Date().toISOString().slice(0, 10)}.pdf`;
                download(mergedPdfBlob, mergedName, 'application/pdf');
                
                mergeProgress.classList.add('hidden');
                mergeFiles = [];
                mergeFileList.innerHTML = '';
                mergeBtn.disabled = true;
                
            } catch (error) {
                console.error('Error al unir PDFs:', error);
                mergeProgress.classList.add('hidden');
                alert('Ocurrió un error al unir los PDFs');
            }
        });

        // Funcionalidad para Extraer páginas
        const extractDropzone = document.getElementById('extract-dropzone');
        const extractFileInput = document.getElementById('extract-file');
        const extractFileInfo = document.getElementById('extract-file-info');
        const extractFileName = document.getElementById('extract-file-name');
        const extractPageCount = document.getElementById('extract-page-count');
        const extractRange = document.getElementById('extract-range');
        const extractPageSelector = document.getElementById('extract-page-selector');
        const extractBtn = document.getElementById('extract-btn');
        const extractProgress = document.getElementById('extract-progress');
        const extractProgressFill = document.getElementById('extract-progress-fill');

        let extractFile = null;
        let totalPages = 0;

        extractDropzone.addEventListener('click', () => extractFileInput.click());
        extractDropzone.addEventListener('dragoover', (e) => {
            e.preventDefault();
            extractDropzone.classList.add('active');
        });
        extractDropzone.addEventListener('dragleave', () => {
            extractDropzone.classList.remove('active');
        });
        extractDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            extractDropzone.classList.remove('active');
            handleExtractFile(e.dataTransfer.files[0]);
        });

        extractFileInput.addEventListener('change', () => {
            if (extractFileInput.files.length > 0) {
                handleExtractFile(extractFileInput.files[0]);
            }
        });

        async function handleExtractFile(file) {
            if (file.type !== 'application/pdf') {
                alert('Por favor, selecciona un archivo PDF');
                return;
            }
            
            extractFile = file;
            extractFileName.textContent = file.name;
            
            try {
                // Obtener el número real de páginas del PDF
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                totalPages = pdfDoc.getPageCount();
                
                extractPageCount.textContent = `${totalPages} pages`;
                
                // Generar botones de selección de páginas
                extractPageSelector.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = 'px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded';
                    pageBtn.textContent = i;
                    pageBtn.dataset.page = i;
                    pageBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        pageBtn.classList.toggle('bg-blue-100', !pageBtn.classList.contains('bg-blue-100'));
                        pageBtn.classList.toggle('text-blue-700', !pageBtn.classList.contains('text-blue-700'));
                        updateExtractRange();
                    });
                    extractPageSelector.appendChild(pageBtn);
                }
                
                extractFileInfo.classList.remove('hidden');
                extractBtn.disabled = false;
                
            } catch (error) {
                console.error('Error al cargar PDF:', error);
                alert('No se pudo cargar el archivo PDF');
            }
        }

        function updateExtractRange() {
            const selectedPages = Array.from(extractPageSelector.querySelectorAll('.bg-blue-100'))
                .map(btn => parseInt(btn.dataset.page))
                .sort((a, b) => a - b);
            
            if (selectedPages.length === 0) {
                extractRange.value = '';
                return;
            }
            
            // Convertir a rangos (ej: 1,2,3,5,6,7 -> 1-3,5-7)
            let ranges = [];
            let start = selectedPages[0];
            let prev = start;
            
            for (let i = 1; i < selectedPages.length; i++) {
                if (selectedPages[i] === prev + 1) {
                    prev = selectedPages[i];
                } else {
                    ranges.push(start === prev ? start : `${start}-${prev}`);
                    start = selectedPages[i];
                    prev = start;
                }
            }
            ranges.push(start === prev ? start : `${start}-${prev}`);
            
            extractRange.value = ranges.join(', ');
        }

        extractRange.addEventListener('input', () => {
            // Limpiar selección de botones
            extractPageSelector.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-700');
            });
            
            // Procesar el rango ingresado
            const ranges = extractRange.value.split(',').map(r => r.trim());
            
            for (const range of ranges) {
                if (range.includes('-')) {
                    const [start, end] = range.split('-').map(n => parseInt(n));
                    if (!isNaN(start) && !isNaN(end) && start <= end && start >= 1 && end <= totalPages) {
                        for (let i = start; i <= end; i++) {
                            const btn = extractPageSelector.querySelector(`button[data-page="${i}"]`);
                            if (btn) {
                                btn.classList.add('bg-blue-100', 'text-blue-700');
                            }
                        }
                    }
                } else {
                    const page = parseInt(range);
                    if (!isNaN(page) && page >= 1 && page <= totalPages) {
                        const btn = extractPageSelector.querySelector(`button[data-page="${page}"]`);
                        if (btn) {
                            btn.classList.add('bg-blue-100', 'text-blue-700');
                        }
                    }
                }
            }
        });

        extractBtn.addEventListener('click', async () => {
            if (!extractFile) return;
            
            extractProgress.classList.remove('hidden');
            extractProgressFill.style.width = '0%';
            
            try {
                // Obtener las páginas seleccionadas
                const selectedPages = Array.from(extractPageSelector.querySelectorAll('.bg-blue-100'))
                    .map(btn => parseInt(btn.dataset.page) - 1); // pdf-lib usa índices base 0
                
                if (selectedPages.length === 0) {
                    alert('Por favor, selecciona al menos una página');
                    extractProgress.classList.add('hidden');
                    return;
                }
                
                // Cargar el PDF original
                const arrayBuffer = await extractFile.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                // Crear un nuevo PDF con las páginas seleccionadas
                const newPdf = await PDFLib.PDFDocument.create();
                const pages = await newPdf.copyPages(pdfDoc, selectedPages);
                pages.forEach(page => newPdf.addPage(page));
                
                // Guardar el nuevo PDF
                const pdfBytes = await newPdf.save();
                const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                // Descargar el PDF
                const extractedName = `paginas_extraidas_${new Date().toISOString().slice(0, 10)}.pdf`;
                download(pdfBlob, extractedName, 'application/pdf');
                
                extractProgressFill.style.width = '100%';
                setTimeout(() => {
                    extractProgress.classList.add('hidden');
                }, 500);
                
            } catch (error) {
                console.error('Error al extraer páginas:', error);
                extractProgress.classList.add('hidden');
                alert('Ocurrió un error al extraer las páginas');
            }
        });

        // Funcionalidad para Comprimir PDF
        const compressDropzone = document.getElementById('compress-dropzone');
        const compressFileInput = document.getElementById('compress-file');
        const compressFileInfo = document.getElementById('compress-file-info');
        const compressFileName = document.getElementById('compress-file-name');
        const compressFileSize = document.getElementById('compress-file-size');
        const compressLevel = document.getElementById('compress-level');
        const compressLevelValue = document.getElementById('compress-level-value');
        const compressBtn = document.getElementById('compress-btn');
        const compressProgress = document.getElementById('compress-progress');
        const compressProgressFill = document.getElementById('compress-progress-fill');
        const compressResult = document.getElementById('compress-result');
        const originalSize = document.getElementById('original-size');
        const compressedSize = document.getElementById('compressed-size');
        const reductionPercent = document.getElementById('reduction-percent');

        let compressFile = null;

        compressDropzone.addEventListener('click', () => compressFileInput.click());
        compressDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            compressDropzone.classList.add('active');
        });
        compressDropzone.addEventListener('dragleave', () => {
            compressDropzone.classList.remove('active');
        });
        compressDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            compressDropzone.classList.remove('active');
            handleCompressFile(e.dataTransfer.files[0]);
        });

        compressFileInput.addEventListener('change', () => {
            if (compressFileInput.files.length > 0) {
                handleCompressFile(compressFileInput.files[0]);
            }
        });

        compressLevel.addEventListener('input', () => {
            compressLevelValue.textContent = compressLevel.value;
        });

        function handleCompressFile(file) {
            if (file.type !== 'application/pdf') {
                alert('Por favor, selecciona un archivo PDF');
                return;
            }
            
            compressFile = file;
            compressFileName.textContent = file.name;
            compressFileSize.textContent = formatFileSize(file.size);
            
            compressFileInfo.classList.remove('hidden');
            compressBtn.disabled = false;
            compressResult.classList.add('hidden');
        }

        compressBtn.addEventListener('click', async () => {
            if (!compressFile) return;
            
            compressProgress.classList.remove('hidden');
            compressProgressFill.style.width = '0%';
            
            try {
                // Cargar el PDF original
                const arrayBuffer = await compressFile.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                // Simular compresión (en un entorno real usarías optimización real)
                // Aquí simplemente re-guardamos el PDF con diferentes opciones
                const level = parseInt(compressLevel.value);
                const optimizeImages = document.getElementById('compress-optimize-images').checked;
                
                // Actualizar progreso
                compressProgressFill.style.width = '50%';
                
                // Simular tiempo de procesamiento
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Guardar con diferentes opciones según el nivel de compresión
                const saveOptions = {
                    useObjectStreams: true, // Reduce tamaño
                    // En un entorno real, aquí aplicarías optimizaciones reales
                };
                
                const pdfBytes = await pdfDoc.save(saveOptions);
                const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                // Calcular resultados
                const original = compressFile.size;
                const compressed = pdfBlob.size;
                
                // Mostrar resultados
                originalSize.textContent = formatFileSize(original);
                compressedSize.textContent = formatFileSize(compressed);
                reductionPercent.textContent = `${Math.round((1 - compressed/original) * 100)}%`;
                
                // Descargar el PDF comprimido
                const compressedName = `documento_comprimido_${new Date().toISOString().slice(0, 10)}.pdf`;
                download(pdfBlob, compressedName, 'application/pdf');
                
                compressProgressFill.style.width = '100%';
                compressResult.classList.remove('hidden');
                
                setTimeout(() => {
                    compressProgress.classList.add('hidden');
                }, 500);
                
            } catch (error) {
                console.error('Error al comprimir PDF:', error);
                compressProgress.classList.add('hidden');
                alert('Ocurrió un error al comprimir el PDF');
            }
        });

        // Funcionalidad para Firmar PDF
        const signDropzone = document.getElementById('sign-dropzone');
        const signFileInput = document.getElementById('sign-file');
        const signFileInfo = document.getElementById('sign-file-info');
        const signFileName = document.getElementById('sign-file-name');
        const signPageCount = document.getElementById('sign-page-count');
        const signPage = document.getElementById('sign-page');
        const signCustomPageContainer = document.getElementById('sign-custom-page-container');
        const signCustomPage = document.getElementById('sign-custom-page');
        const signUploadBtn = document.getElementById('sign-upload-btn');
        const signDrawBtn = document.getElementById('sign-draw-btn');
        const signTokenBtn = document.getElementById('sign-token-btn');
        const signImageInput = document.getElementById('sign-image');
        const signaturePreview = document.getElementById('signature-preview');
        const signPosition = document.getElementById('sign-position');
        const signSize = document.getElementById('sign-size');
        const signBtn = document.getElementById('sign-btn');
        const signProgress = document.getElementById('sign-progress');
        const signProgressFill = document.getElementById('sign-progress-fill');
        const drawModal = document.getElementById('draw-modal');
        const signatureCanvas = document.getElementById('signature-canvas');
        const clearSignature = document.getElementById('clear-signature');
        const cancelSignature = document.getElementById('cancel-signature');
        const saveSignature = document.getElementById('save-signature');
        const tokenModal = document.getElementById('token-modal');
        const cancelToken = document.getElementById('cancel-token');
        const confirmToken = document.getElementById('confirm-token');

        let signFile = null;
        let signatureImage = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        const ctx = signatureCanvas.getContext('2d');

        // Configurar canvas
        function setupCanvas() {
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCanvas.width = rect.width;
            signatureCanvas.height = rect.height;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }

        // Eventos para dibujar en el canvas
        signatureCanvas.addEventListener('mousedown', startDrawing);
        signatureCanvas.addEventListener('touchstart', startDrawing);
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('touchmove', draw);
        signatureCanvas.addEventListener('mouseup', stopDrawing);
        signatureCanvas.addEventListener('touchend', stopDrawing);
        signatureCanvas.addEventListener('mouseout', stopDrawing);

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPosition(e);
            lastX = pos.x;
            lastY = pos.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const pos = getPosition(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            
            lastX = pos.x;
            lastY = pos.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function getPosition(e) {
            const rect = signatureCanvas.getBoundingClientRect();
            return {
                x: (e.clientX || e.touches[0].clientX) - rect.left,
                y: (e.clientY || e.touches[0].clientY) - rect.top
            };
        }

        // Manejo de archivo PDF para firmar
        signDropzone.addEventListener('click', () => signFileInput.click());
        signDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            signDropzone.classList.add('active');
        });
        signDropzone.addEventListener('dragleave', () => {
            signDropzone.classList.remove('active');
        });
        signDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            signDropzone.classList.remove('active');
            handleSignFile(e.dataTransfer.files[0]);
        });

        signFileInput.addEventListener('change', () => {
            if (signFileInput.files.length > 0) {
                handleSignFile(signFileInput.files[0]);
            }
        });

        async function handleSignFile(file) {
            if (file.type !== 'application/pdf') {
                alert('Por favor, selecciona un archivo PDF');
                return;
            }
            
            signFile = file;
            signFileName.textContent = file.name;
            
            try {
                // Obtener el número real de páginas del PDF
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPageCount();
                
                signPageCount.textContent = `${pages} páginas`;
                
                // Actualizar opción de página personalizada
                signCustomPage.max = pages;
                
                signFileInfo.classList.remove('hidden');
                signPage.disabled = false;
                updateSignBtnState();
                
            } catch (error) {
                console.error('Error al cargar PDF:', error);
                alert('No se pudo cargar el archivo PDF');
            }
        }

        // Manejo de selección de página
        signPage.addEventListener('change', () => {
            if (signPage.value === 'custom') {
                signCustomPageContainer.classList.remove('hidden');
            } else {
                signCustomPageContainer.classList.add('hidden');
            }
        });

        // Manejo de firma (subir imagen)
        signUploadBtn.addEventListener('click', () => signImageInput.click());
        signImageInput.addEventListener('change', () => {
            if (signImageInput.files.length > 0) {
                const file = signImageInput.files[0];
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    signatureImage = e.target.result;
                    signaturePreview.innerHTML = `<img src="${signatureImage}" alt="Firma" class="max-w-full max-h-32">`;
                    updateSignBtnState();
                };
                
                reader.readAsDataURL(file);
            }
        });

        // Manejo de firma (dibujar)
        signDrawBtn.addEventListener('click', () => {
            setupCanvas();
            drawModal.classList.remove('hidden');
        });

        clearSignature.addEventListener('click', () => {
            ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        });

        cancelSignature.addEventListener('click', () => {
            drawModal.classList.add('hidden');
        });

        saveSignature.addEventListener('click', () => {
            const dataUrl = signatureCanvas.toDataURL('image/png');
            signatureImage = dataUrl;
            signaturePreview.innerHTML = `<img src="${dataUrl}" alt="Firma dibujada" class="max-w-full max-h-32">`;
            drawModal.classList.add('hidden');
            updateSignBtnState();
        });

        // Manejo de firma (e-Token)
        signTokenBtn.addEventListener('click', () => {
            tokenModal.classList.remove('hidden');
        });

        cancelToken.addEventListener('click', () => {
            tokenModal.classList.add('hidden');
        });

        confirmToken.addEventListener('click', () => {
            const cert = document.getElementById('token-certificate').value;
            const password = document.getElementById('token-password').value;
            
            if (!cert || !password) {
                alert('Por favor, selecciona un certificado e ingresa la contraseña');
                return;
            }
            
            // Simular firma con token
            signatureImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMTAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjEwMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzAwMCI+RmlybWEgRGlnaXRhbDwvdGV4dD48L3N2Zz4=';
            signaturePreview.innerHTML = `<img src="${signatureImage}" alt="Firma digital" class="max-w-full max-h-32">`;
            
            tokenModal.classList.add('hidden');
            updateSignBtnState();
        });

        // Actualizar estado del botón de firma
        function updateSignBtnState() {
            signBtn.disabled = !(signFile && signatureImage);
        }

        // Firmar documento
        signBtn.addEventListener('click', async () => {
            if (!signFile || !signatureImage) return;
            
            signProgress.classList.remove('hidden');
            signProgressFill.style.width = '0%';
            
            try {
                // Cargar el PDF original
                const arrayBuffer = await signFile.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                // Determinar qué páginas firmar
                let pagesToSign = [];
                const pageOption = signPage.value;
                
                if (pageOption === 'first') {
                    pagesToSign = [0];
                } else if (pageOption === 'last') {
                    pagesToSign = [pdfDoc.getPageCount() - 1];
                } else if (pageOption === 'all') {
                    pagesToSign = Array.from({ length: pdfDoc.getPageCount() }, (_, i) => i);
                } else if (pageOption === 'custom') {
                    const customPage = parseInt(signCustomPage.value) - 1; // Convertir a índice base 0
                    if (customPage >= 0 && customPage < pdfDoc.getPageCount()) {
                        pagesToSign = [customPage];
                    } else {
                        throw new Error('Número de página inválido');
                    }
                }
                
                // Cargar la imagen de firma
                let signatureImageBytes;
                if (signatureImage.startsWith('data:image/svg')) {
                    // Usar la firma SVG del token (simulación)
                    signatureImageBytes = await fetch(signatureImage).then(res => res.arrayBuffer());
                } else {
                    // Convertir imagen de firma a bytes
                    const response = await fetch(signatureImage);
                    signatureImageBytes = await response.arrayBuffer();
                }
                
                // Embed la imagen en el PDF
                let signatureImageObj;
                if (signatureImage.includes('png')) {
                    signatureImageObj = await pdfDoc.embedPng(signatureImageBytes);
                } else if (signatureImage.includes('jpeg') || signatureImage.includes('jpg')) {
                    signatureImageObj = await pdfDoc.embedJpg(signatureImageBytes);
                } else {
                    // Intentar como PNG por defecto
                    signatureImageObj = await pdfDoc.embedPng(signatureImageBytes);
                }
                
                const sizeFactor = signSize.value / 100;
                const signatureDims = signatureImageObj.scale(sizeFactor);
                
                // Aplicar firma a cada página seleccionada
                for (const pageIndex of pagesToSign) {
                    const page = pdfDoc.getPage(pageIndex);
                    const { width, height } = page.getSize();
                    
                    // Determinar posición según selección
                    let x, y;
                    const position = signPosition.value;
                    
                    // Margen de 20 puntos desde los bordes
                    const margin = 20;
                    
                    if (position === 'bottom-right') {
                        x = width - signatureDims.width - margin;
                        y = margin;
                    } else if (position === 'bottom-left') {
                        x = margin;
                        y = margin;
                    } else if (position === 'top-right') {
                        x = width - signatureDims.width - margin;
                        y = height - signatureDims.height - margin;
                    } else if (position === 'top-left') {
                        x = margin;
                        y = height - signatureDims.height - margin;
                    } else { // center
                        x = (width - signatureDims.width) / 2;
                        y = (height - signatureDims.height) / 2;
                    }
                    
                    // Dibujar firma
                    page.drawImage(signatureImageObj, {
                        x,
                        y,
                        width: signatureDims.width,
                        height: signatureDims.height,
                    });
                }
                
                // Actualizar progreso
                signProgressFill.style.width = '80%';
                
                // Guardar el PDF firmado
                const pdfBytes = await pdfDoc.save();
                const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                // Descargar el PDF
                const signedName = `documento_firmado_${new Date().toISOString().slice(0, 10)}.pdf`;
                download(pdfBlob, signedName, 'application/pdf');
                
                signProgressFill.style.width = '100%';
                
                setTimeout(() => {
                    signProgress.classList.add('hidden');
                }, 500);
                
            } catch (error) {
                console.error('Error al firmar PDF:', error);
                signProgress.classList.add('hidden');
                alert('Ocurrió un error al firmar el PDF. Por favor, verifica que la imagen de firma sea válida.');
            }
        });

        // Función auxiliar para formatear tamaño de archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Inicializar canvas al cargar
        window.addEventListener('load', setupCanvas);
    </script>
<p style="border-radius: 8px; text-align: center; font-size: 12px; color: #fff; margin-top: 16px;position: fixed; left: 8px; bottom: 8px; z-index: 10; background: rgba(0, 0, 0, 0.8); padding: 4px 8px;">Made with <img src="https://enzostvs-deepsite.hf.space/logo.svg" alt="DeepSite Logo" style="width: 16px; height: 16px; vertical-align: middle;display:inline-block;margin-right:3px;filter:brightness(0) invert(1);"><a href="https://enzostvs-deepsite.hf.space" style="color: #fff;text-decoration: underline;" target="_blank" >DeepSite</a> - 🧬 <a href="https://enzostvs-deepsite.hf.space?remix=luzu67/aigde" style="color: #fff;text-decoration: underline;" target="_blank" >Remix</a></p></body>
</html>